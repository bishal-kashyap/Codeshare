steps:
- checkout: self
  persistCredentials: true

- bash: |
    set -euo pipefail
    git config --global --add safe.directory "$(Build.SourcesDirectory)"

    echo "Formatting Terraform files..."
    terraform fmt -recursive

    echo "Checking for changes..."
    if git diff --quiet; then
      echo "No changes to commit."
      exit 0
    fi

    echo "Configuring Git..."
    git config user.name  "azdo-bot"
    git config user.email "azdo-bot@local"

    git add -A
    git commit -m "chore(fmt): terraform auto-format [skip ci]"

    # Explicitly use System.AccessToken in push URL
    git push https://$(System.AccessToken)@dev.azure.com/$(System.CollectionUri#https://dev.azure.com/)$(Build.Repository.Name).git HEAD:$(Build.SourceBranchName)
  displayName: "terraform fmt + auto-push"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  condition: ne(variables['Build.Reason'], 'PullRequest')
