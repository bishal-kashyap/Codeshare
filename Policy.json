- task: AzureCLI@2
  displayName: "Validate subscription name is unique"
  inputs:
    azureSubscription: R-CSSPZ-MI-MAN-SF-SC-PRD-001
    scriptType: bash
    scriptLocation: inlineScript
    workingDirectory: '$(System.DefaultWorkingDirectory)/Azure_Subscription/env'
    inlineScript: |
      set -e
      tfvarsfile="CSPZ_AZR-TEST-EUC-AVD.tfvars"

      # Extract subscription_name from HCL map style tfvars
      name=$(grep -E '^[[:space:]]*subscription_name[[:space:]]*=' "$tfvarsfile" | sed -E 's/^[^"]*"([^"]*)".*/\1/')

      echo "Checking subscription: $name"

      if az account list --all --query "[].name" -o tsv | grep -i -x "$name" >/dev/null; then
        echo "❌ Subscription '$name' already exists."
        exit 1
      else
        echo "✅ No existing subscription named '$name'."
      fi
