provider "azapi" {}

data "azapi_resource_list" "subs" {
  type                   = "Microsoft.Subscription/Subscriptions@2021-01-01"
  response_export_values = ["displayName"]
}

locals {
  existing_subscription_names = [
    for s in try(data.azapi_resource_list.subs.output.value, []) :
    trimspace(lower(s.displayName))
  ]
}


variable "subscription_name" {
  type = string

  validation {
    condition     = !contains(local.existing_subscription_names, trimspace(lower(var.subscription_name)))
    error_message = "A subscription with the name '${var.subscription_name}' already exists in this tenant."
  }
}

