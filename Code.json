# ------------------------------------------------------------------------------------ #
# Description:
#    Pipeline to deploy subscription in BOIPROD Azure Tenant
#
# ------------------------------------------------------------------------------------ #

trigger: none


pool:
  name: 'M-CSSPZ-PBA-MAN-PRD-004'

stages:
- stage: Build
  displayName: 'Build'
  jobs:
  - job: Build
    displayName: 'Build'
    steps:
    - script: sudo yum install -y yum-utils git wget unzip python3 python3-pip
    - script: sudo wget https://github.com/terraform-linters/tflint/releases/download/v0.47.0/tflint_linux_amd64.zip
    - script: sudo unzip tflint_linux_amd64.zip
    - script: sudo mv tflint /usr/local/bin/
    - checkout: self
    - script: |
          rm -f tflint_linux_amd64.zip
          sudo rm -f /usr/local/bin/tflint
          sudo rm -rf ~/.tflint.d
          sudo rm -rf ~/.terraform.d
          sudo rm -rf /tmp/*
          sudo yum clean all
          echo "Cleanup done"    
#    - script: |
#       pip3 install --user checkov
#        export PATH=$PATH:~/.local/bin
#        echo $PATH
#        checkov --version
#       mkdir -p $(System.DefaultWorkingDirectory)/CheckovReport
#        checkov -d $(System.DefaultWorkingDirectory)/CheckovReport --output junitxml > $(System.DefaultWorkingDirectory)/CheckovReport/Checkov-Report.xml
#      displayName: "Install & Run Checkov"   

#    - task: PublishTestResults@2
#      inputs:
#       testResultsFiles: $(System.DefaultWorkingDirectory)/CheckovReport/Checkov-Report.xml
#        testRunTitle: 'Checkov Scan Results'
#      displayName: 'Publish Checkov Report'

#    - task: PublishBuildArtifacts@1
#      inputs:
#        PathtoPublish: $(System.DefaultWorkingDirectory)/CheckovReport/Checkov-Report.xml
#        ArtifactName: 'drop'
#        publishLocation: 'Container'
#      displayName: 'Publish Checkov Artifact'   

    - script: ls $(System.DefaultWorkingDirectory)
    - script: ls $(System.DefaultWorkingDirectory)/Azure_Subscription
    - script: ls $(System.DefaultWorkingDirectory)/Azure_Subscription/env
    - script: sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
    - script: sudo yum -y install terraform 

    - task: TerraformCLI@1
      displayName: 'Terraform Format'
      inputs:
        command: "fmt"
        arguments: "-check -recursive"
        workingDirectory: "$(System.DefaultWorkingDirectory)/Azure_Subscription/env"
        allowTelemetryCollection: false
      continueOnError: true  
